<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายละเอียดบริษัท</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
    .header { background: #1DB446; color: white; padding: 20px; }
    .header h1 { font-size: 1.3em; }
    .header .sub { font-size: 0.85em; opacity: 0.8; margin-top: 4px; }
    .container { padding: 15px; max-width: 600px; margin: 0 auto; }
    .section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section h3 { color: #1DB446; font-size: 0.95em; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 6px; }
    .field { display: flex; padding: 6px 0; border-bottom: 1px solid #f5f5f5; }
    .field:last-child { border-bottom: none; }
    .field .label { color: #999; font-size: 0.85em; width: 120px; flex-shrink: 0; }
    .field .value { font-size: 0.85em; color: #333; flex: 1; }
    .table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    .table th { background: #f8f8f8; padding: 8px; text-align: left; font-weight: 600; color: #666; }
    .table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
    .table tr:nth-child(even) { background: #fafafa; }
    .table .text-right { text-align: right; }
    .doc-item { padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .doc-item:last-child { border-bottom: none; }
    .doc-item .doc-name { font-size: 0.9em; color: #333; }
    .doc-item .doc-meta { font-size: 0.75em; color: #17A2B8; margin-top: 2px; }
    .doc-item .doc-actions { margin-top: 6px; display: flex; gap: 8px; }
    .doc-item .doc-actions a, .doc-item .doc-actions button { color: white; background: #17A2B8; padding: 4px 12px; border-radius: 4px; font-size: 0.8em; text-decoration: none; border: none; cursor: pointer; }
    .doc-item .doc-actions a.secondary, .doc-item .doc-actions button.secondary { background: #6c757d; }
    .doc-item .doc-actions button.dl-btn { background: #1DB446; }
    .seal-img { max-width: 200px; margin: 10px auto; display: block; }
    .loading { text-align: center; padding: 40px; color: #999; }
    .error { text-align: center; padding: 40px; color: #e74c3c; }
    .sh-bar { display: flex; align-items: center; margin-bottom: 6px; }
    .sh-bar .sh-name { font-size: 0.85em; color: #333; flex: 1; }
    .sh-bar .sh-pct { font-size: 0.85em; color: #1DB446; font-weight: 600; width: 50px; text-align: right; }
    .sh-bar-track { height: 6px; background: #eee; border-radius: 3px; margin-bottom: 10px; }
    .sh-bar-fill { height: 100%; background: #1DB446; border-radius: 3px; }
    .sh-detail { font-size: 0.75em; color: #999; margin-top: -8px; margin-bottom: 10px; }
    .timeline { position: relative; padding-left: 20px; }
    .timeline::before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; width: 2px; background: #e0e0e0; }
    .timeline-item { position: relative; padding-bottom: 16px; }
    .timeline-item::before { content: ''; position: absolute; left: -17px; top: 4px; width: 10px; height: 10px; border-radius: 50%; background: #1DB446; border: 2px solid white; box-shadow: 0 0 0 2px #1DB446; }
    .timeline-item .tl-date { font-size: 0.75em; color: #999; }
    .timeline-item .tl-field { font-size: 0.85em; color: #333; font-weight: 600; margin-top: 2px; }
    .timeline-item .tl-change { font-size: 0.8em; margin-top: 4px; }
    .timeline-item .tl-old { color: #e74c3c; }
    .timeline-item .tl-new { color: #1DB446; }
    .timeline-item .tl-by { font-size: 0.75em; color: #aaa; margin-top: 2px; }
    .empty-msg { text-align: center; color: #999; font-size: 0.85em; padding: 20px 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="companyName">กำลังโหลด...</h1>
    <div class="sub" id="companyNameEn"></div>
    <div class="sub" id="dataDate"></div>
  </div>
  <div class="container" id="content">
    <div class="loading">กำลังโหลดข้อมูล...</div>
  </div>
  <script src="/liff/env.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const companyName = params.get('company') || '';
    const apiBase = window.location.origin;
    let canDownload = true; // default true, will be updated after LIFF init

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function getExpiryStatus(expiryDateStr) {
      if (!expiryDateStr) return null;
      const trimmed = expiryDateStr.trim();
      let expiry = null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
        expiry = new Date(trimmed + 'T00:00:00');
      } else {
        const match = trimmed.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})$/);
        if (match) expiry = new Date(match[3] + '-' + match[2].padStart(2,'0') + '-' + match[1].padStart(2,'0') + 'T00:00:00');
      }
      if (!expiry || isNaN(expiry.getTime())) return null;
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.ceil((expiry.getTime() - today.getTime()) / (1000*60*60*24));
      if (diff < 0) return 'expired';
      if (diff <= 7) return 'expiring-7d';
      if (diff <= 30) return 'expiring-30d';
      return 'ok';
    }

    async function loadData() {
      try {
        const [companyRes, versionsRes] = await Promise.all([
          fetch(`${apiBase}/api/liff/company/${encodeURIComponent(companyName)}`),
          fetch(`${apiBase}/api/liff/versions/${encodeURIComponent(companyName)}`),
        ]);
        if (!companyRes.ok) throw new Error('Failed to load');
        const c = await companyRes.json();
        const versions = versionsRes.ok ? await versionsRes.json() : [];

        document.getElementById('companyName').textContent = c.companyNameTh || c.sheetName;
        document.getElementById('companyNameEn').textContent = c.companyNameEn || '';
        document.getElementById('dataDate').textContent = c.dataDate || '';

        let html = '';

        // Basic info
        html += `<div class="section"><h3>ข้อมูลทั่วไป</h3>
          <div class="field"><span class="label">เลขทะเบียน</span><span class="value">${escapeHtml(c.registrationNumber) || '-'}</span></div>
          <div class="field"><span class="label">ทุนจดทะเบียน</span><span class="value">${c.capitalText || (c.registeredCapital ? c.registeredCapital.toLocaleString() + ' บาท' : '-')}</span></div>
          <div class="field"><span class="label">อำนาจกรรมการ</span><span class="value">${escapeHtml(c.authorizedSignatory) || '-'}</span></div>
          <div class="field"><span class="label">ที่อยู่</span><span class="value">${escapeHtml(c.headOfficeAddress) || '-'}</span></div>
          <div class="field"><span class="label">วัตถุประสงค์</span><span class="value">${escapeHtml(c.objectives) || '-'}</span></div>
        </div>`;

        // Seal image
        const sealSrc = c.sealImageUrl || (c.sealImageDriveId ? `${apiBase}/api/seal/${c.sealImageDriveId}` : '');
        if (sealSrc) {
          html += `<div class="section"><h3>ตราประทับ</h3>
            <img src="${sealSrc}" alt="ตราประทับ" class="seal-img" onerror="this.style.display='none'">
          </div>`;
        }

        // Directors
        if (c.directors && c.directors.length) {
          html += `<div class="section"><h3>กรรมการ (${c.directors.length} คน)</h3><table class="table">
            <tr><th>#</th><th>ชื่อ</th><th>ตำแหน่ง</th></tr>
            ${c.directors.map((d, i) => `<tr><td>${i+1}</td><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.position) || '-'}</td></tr>`).join('')}
          </table></div>`;
        }

        // Shareholders — detailed
        if (c.shareholders && c.shareholders.length) {
          const totalShares = c.shareholders.reduce((sum, s) => sum + (s.shares || 0), 0);
          html += `<div class="section"><h3>ผู้ถือหุ้น (${c.shareholders.length} คน)</h3>`;
          c.shareholders.forEach(s => {
            const pct = s.percentage || 0;
            html += `<div class="sh-bar">
              <span class="sh-name">${s.order}. ${escapeHtml(s.name)}</span>
              <span class="sh-pct">${pct ? pct + '%' : '-'}</span>
            </div>
            <div class="sh-bar-track"><div class="sh-bar-fill" style="width:${Math.min(pct, 100)}%"></div></div>
            <div class="sh-detail">${s.shares ? s.shares.toLocaleString() + ' หุ้น' : ''}</div>`;
          });
          if (totalShares > 0) {
            html += `<div style="font-size:0.8em;color:#999;border-top:1px solid #eee;padding-top:8px;margin-top:4px;">
              รวมทั้งหมด ${totalShares.toLocaleString()} หุ้น
            </div>`;
          }
          html += `</div>`;
        }

        // Documents
        if (c.documents && c.documents.length) {
          html += `<div class="section"><h3>เอกสาร (${c.documents.length} รายการ)</h3>
            ${c.documents.map(d => {
              let actions = '';
              if (d.driveFileId && !d.driveFileId.startsWith('http')) {
                const viewerUrl = `/liff/doc-viewer.html?fileId=${encodeURIComponent(d.driveFileId)}&name=${encodeURIComponent(d.name)}`;
                const fileId = encodeURIComponent(d.driveFileId);
                actions = `<a href="${viewerUrl}">ดู PDF</a>`;
                if (canDownload) {
                  actions += `<button class="dl-btn" onclick="downloadOrPrint('${fileId}','${encodeURIComponent(d.name)}')">โหลด/ปริ้น</button>`;
                }
              } else if (d.driveUrl) {
                actions = `<a href="${d.driveUrl}" target="_blank">เปิด</a>`;
              }
              let expiryHtml = '';
              if (d.expiryDate) {
                const es = getExpiryStatus(d.expiryDate);
                const esLabel = es === 'expired' ? 'หมดอายุแล้ว' : es === 'expiring-7d' ? 'หมดอายุใน 7 วัน' : es === 'expiring-30d' ? 'หมดอายุใน 30 วัน' : '';
                const esColor = es === 'expired' ? '#DC3545' : es === 'expiring-7d' ? '#E65100' : es === 'expiring-30d' ? '#F57F17' : '#999';
                expiryHtml = `<div class="doc-meta" style="color:${esColor}">หมดอายุ: ${escapeHtml(d.expiryDate)}${esLabel ? ' (' + esLabel + ')' : ''}</div>`;
              }
              return `<div class="doc-item">
                <div class="doc-name">${escapeHtml(d.name)}</div>
                ${d.updatedDate ? `<div class="doc-meta">อัปเดต: ${escapeHtml(d.updatedDate)}</div>` : d.type ? `<div class="doc-meta">${escapeHtml(d.type)}</div>` : ''}
                ${expiryHtml}
                <div class="doc-actions">${actions}</div>
              </div>`;
            }).join('')}
          </div>`;
        }

        // Version History
        html += `<div class="section"><h3>ประวัติการเปลี่ยนแปลง</h3>`;
        if (versions.length > 0) {
          html += `<div class="timeline" id="versionTimeline">`;
          versions.forEach((v, idx) => {
            html += `<div class="timeline-item" ${idx >= 5 ? 'style="display:none;" data-extra-version' : ''}>
              <div class="tl-date">${escapeHtml(v.timestamp)}</div>
              <div class="tl-field">${escapeHtml(v.fieldChanged)}</div>
              <div class="tl-change">
                ${v.oldValue ? `<span class="tl-old">${escapeHtml(v.oldValue)}</span> → ` : ''}
                <span class="tl-new">${escapeHtml(v.newValue)}</span>
              </div>
              ${v.changedBy ? `<div class="tl-by">โดย ${escapeHtml(v.changedBy)}</div>` : ''}
            </div>`;
          });
          html += `</div>`;
          if (versions.length > 5) {
            html += `<div style="text-align:center;margin-top:10px;">
              <button id="showMoreVersions" onclick="showAllVersions()" style="background:#1DB446;color:white;border:none;padding:8px 20px;border-radius:6px;font-size:0.85em;cursor:pointer;">ดูเพิ่มเติม (${versions.length - 5} รายการ)</button>
            </div>`;
          }
        } else {
          html += `<div class="empty-msg">ยังไม่มีประวัติการเปลี่ยนแปลง</div>`;
        }
        html += `</div>`;

        document.getElementById('content').innerHTML = html;
      } catch (err) {
        document.getElementById('content').innerHTML = '<div class="error">ไม่สามารถโหลดข้อมูลได้</div>';
      }
    }

    function showAllVersions() {
      document.querySelectorAll('[data-extra-version]').forEach(el => el.style.display = '');
      document.getElementById('showMoreVersions').style.display = 'none';
    }

    function isMobile() {
      return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }

    function downloadOrPrint(fileId, name) {
      const viewUrl = `${apiBase}/api/view/${fileId}`;
      const downloadUrl = `${apiBase}/api/download/${fileId}`;

      if (isMobile()) {
        // Mobile: open PDF in external browser for native print
        if (typeof liff !== 'undefined' && liff.isInClient()) {
          liff.openWindow({ url: viewUrl, external: true });
        } else {
          window.open(viewUrl, '_blank');
        }
      } else {
        // Desktop: download file directly
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = decodeURIComponent(name);
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => document.body.removeChild(a), 1000);
      }
    }

    (async () => {
      try {
        await liff.init({ liffId: window.LIFF_ID });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          const permRes = await fetch(`${apiBase}/api/liff/permission/${encodeURIComponent(profile.userId)}`);
          if (permRes.ok) {
            const perm = await permRes.json();
            canDownload = perm.canDownloadDocuments !== false;
          }
        }
      } catch (e) {
        console.warn('LIFF init skipped:', e);
      }
      loadData();
    })();
  </script>
</body>
</html>
