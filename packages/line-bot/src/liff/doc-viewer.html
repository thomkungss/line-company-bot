<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>เอกสาร</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; height: 100vh; display: flex; flex-direction: column; }

    .toolbar {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 14px;
      background: #fff;
      border-bottom: 1px solid #e5e5e5;
      flex-shrink: 0;
    }
    .toolbar .doc-name {
      flex: 1; font-size: 0.9em; font-weight: 600; color: #333;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .toolbar .btn {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 8px 14px; border-radius: 8px; font-size: 0.82em; font-weight: 600;
      text-decoration: none; border: none; cursor: pointer;
      white-space: nowrap; flex-shrink: 0;
    }
    .btn-download {
      background: #0D99FF; color: #fff;
    }
    .btn-download:active { background: #0B7FD4; }
    .btn-close {
      background: #f0f0f0; color: #555;
    }
    .btn-close:active { background: #e0e0e0; }

    .viewer {
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
    }
    .viewer iframe {
      flex: 1; border: none; width: 100%;
    }

    .loading-screen {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #999; gap: 12px;
    }
    .spinner {
      width: 32px; height: 32px; border: 3px solid #e0e0e0; border-top-color: #0D99FF;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px;
      border-radius: 20px; font-size: 0.85em; z-index: 100;
      opacity: 0; transition: opacity 0.3s;
    }
    .toast.show { opacity: 1; }

    /* Download progress overlay */
    .dl-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 50;
      flex-direction: column; align-items: center; justify-content: center;
    }
    .dl-overlay.show { display: flex; }
    .dl-box {
      background: #fff; border-radius: 16px; padding: 28px 32px;
      text-align: center; max-width: 280px;
    }
    .dl-box .spinner { margin: 0 auto 12px; }
    .dl-box p { font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="doc-name" id="docName">เอกสาร</div>
    <button class="btn btn-download" id="btnDownload" onclick="downloadFile()">
      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M12 4v12m0 0l-4-4m4 4l4-4M4 18h16"/></svg>
      บันทึก
    </button>
    <button class="btn btn-close" onclick="closePage()">ปิด</button>
  </div>

  <div class="viewer" id="viewer">
    <div class="loading-screen" id="loadingScreen">
      <div class="spinner"></div>
      <div>กำลังโหลดเอกสาร...</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="dl-overlay" id="dlOverlay">
    <div class="dl-box">
      <div class="spinner"></div>
      <p>กำลังบันทึกไฟล์...</p>
    </div>
  </div>

  <script src="/liff/env.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const fileId = params.get('fileId') || '';
    const mode = params.get('mode'); // 'download' for direct download
    const docName = params.get('name') || 'เอกสาร';
    const apiBase = window.location.origin;

    document.getElementById('docName').textContent = docName;

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    function closePage() {
      try { liff.closeWindow(); } catch (e) {}
      window.close();
    }

    // Detect OS
    function getOS() {
      const ua = navigator.userAgent;
      if (/iPad|iPhone|iPod/.test(ua)) return 'ios';
      if (/android/i.test(ua)) return 'android';
      return 'other';
    }

    async function downloadFile() {
      if (!fileId) return;
      const overlay = document.getElementById('dlOverlay');
      overlay.classList.add('show');

      try {
        const os = getOS();
        const downloadUrl = `${apiBase}/api/download/${encodeURIComponent(fileId)}`;

        // Try blob download (works on Android Chrome & some iOS webviews)
        try {
          const res = await fetch(downloadUrl);
          if (!res.ok) throw new Error('fetch failed');
          const blob = await res.blob();
          const fileName = getFileNameFromResponse(res) || docName;

          // Create blob URL and trigger download
          const blobUrl = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = fileName;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();

          // Cleanup after delay
          setTimeout(() => {
            URL.revokeObjectURL(blobUrl);
            document.body.removeChild(a);
          }, 3000);

          overlay.classList.remove('show');
          showToast('บันทึกไฟล์สำเร็จ');
          return;
        } catch (blobErr) {
          console.warn('Blob download failed, trying external:', blobErr);
        }

        // Fallback: open in external browser (system handles download)
        overlay.classList.remove('show');
        if (typeof liff !== 'undefined' && liff.isInClient()) {
          liff.openWindow({ url: downloadUrl, external: true });
          showToast('เปิดในเบราว์เซอร์เพื่อบันทึก');
        } else {
          window.open(downloadUrl, '_blank');
        }
      } catch (err) {
        overlay.classList.remove('show');
        showToast('ไม่สามารถบันทึกได้');
        console.error(err);
      }
    }

    function getFileNameFromResponse(res) {
      const cd = res.headers.get('content-disposition');
      if (!cd) return null;
      const match = cd.match(/filename\*?=(?:UTF-8''|"?)([^";]+)/i);
      if (match) return decodeURIComponent(match[1].replace(/"/g, ''));
      return null;
    }

    function loadViewer() {
      const viewer = document.getElementById('viewer');
      const viewUrl = `${apiBase}/api/view/${encodeURIComponent(fileId)}`;

      // Use iframe for PDF viewing
      const iframe = document.createElement('iframe');
      iframe.src = viewUrl;
      iframe.style.flex = '1';
      iframe.style.border = 'none';
      iframe.style.width = '100%';
      iframe.onload = () => {
        document.getElementById('loadingScreen').style.display = 'none';
      };
      // Also hide loading after timeout (iframe onload may not fire for PDFs)
      setTimeout(() => {
        document.getElementById('loadingScreen').style.display = 'none';
      }, 3000);

      viewer.appendChild(iframe);
    }

    (async () => {
      // Init LIFF
      try {
        const liffId = window.LIFF_ID || '';
        if (liffId) await liff.init({ liffId });
      } catch (e) {
        console.warn('LIFF init skipped:', e);
      }

      if (!fileId) {
        document.getElementById('loadingScreen').innerHTML =
          '<div style="color:#e74c3c;">ไม่พบรหัสเอกสาร</div>';
        return;
      }

      // If mode=download, trigger download immediately
      if (mode === 'download') {
        await downloadFile();
        return;
      }

      loadViewer();
    })();
  </script>
</body>
</html>
