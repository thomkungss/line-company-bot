<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สมัครใช้งาน — Company Secretary</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
    .header { background: #1DB446; color: white; padding: 20px; text-align: center; }
    .header h1 { font-size: 1.2em; }
    .header p { font-size: 0.85em; opacity: 0.8; margin-top: 4px; }
    .container { padding: 20px; max-width: 480px; margin: 0 auto; }
    .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #1DB446; margin-bottom: 12px; }
    .avatar-placeholder { width: 80px; height: 80px; border-radius: 50%; background: #e9ecef; display: inline-flex; align-items: center; justify-content: center; font-size: 2em; color: #999; margin-bottom: 12px; }
    .name { font-size: 1.3em; font-weight: 700; color: #333; margin-bottom: 4px; }
    .role-badge { display: inline-block; background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: 600; margin-bottom: 16px; }
    .info { font-size: 0.85em; color: #999; margin-bottom: 20px; line-height: 1.5; }
    .btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #1DB446; color: white; }
    .btn-primary:hover { background: #17a03d; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .loading { text-align: center; padding: 60px 20px; color: #999; }
    .loading .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #eee; border-top-color: #1DB446; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .result { text-align: center; padding: 20px; }
    .result-icon { font-size: 3em; margin-bottom: 12px; }
    .result-icon.success { color: #1DB446; }
    .result-icon.error { color: #e74c3c; }
    .result-icon.warning { color: #F39C12; }
    .result-msg { font-size: 1.05em; font-weight: 500; margin-bottom: 8px; }
    .result-sub { font-size: 0.85em; color: #999; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Company Secretary</h1>
    <p>สมัครใช้งาน</p>
  </div>
  <div class="container">
    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <div>กำลังโหลดข้อมูล LINE...</div>
      </div>
    </div>
  </div>
  <script src="/liff/env.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    let profileData = null;

    async function init() {
      const content = document.getElementById('content');
      try {
        const liffId = window.LIFF_ID || '';
        if (!liffId) {
          showError('ไม่พบการตั้งค่า LIFF');
          return;
        }

        await liff.init({ liffId });

        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
          return;
        }

        const profile = await liff.getProfile();
        profileData = {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl || '',
        };

        showRegistrationForm(profileData);
      } catch (err) {
        console.error('LIFF init error:', err);
        showError('เกิดข้อผิดพลาดในการโหลดข้อมูล');
      }
    }

    function showRegistrationForm(profile) {
      const content = document.getElementById('content');
      const avatarHtml = profile.pictureUrl
        ? '<img src="' + escHtml(profile.pictureUrl) + '" alt="Profile" class="avatar">'
        : '<div class="avatar-placeholder">?</div>';

      content.innerHTML =
        '<div class="card">' +
          avatarHtml +
          '<div class="name">' + escHtml(profile.displayName) + '</div>' +
          '<div class="role-badge">viewer</div>' +
          '<div class="info">คุณจะสมัครเป็นผู้ใช้งานระดับ viewer<br>หลังสมัครแล้วจะต้องรอผู้ดูแลระบบอนุมัติก่อนถึงจะใช้งานได้</div>' +
          '<button class="btn btn-primary" id="registerBtn" onclick="doRegister()">สมัครใช้งาน</button>' +
        '</div>';
    }

    async function doRegister() {
      if (!profileData) return;
      const btn = document.getElementById('registerBtn');
      btn.disabled = true;
      btn.textContent = 'กำลังสมัคร...';

      try {
        const res = await fetch('/api/liff/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData),
        });
        const data = await res.json();

        if (res.ok && data.success) {
          showResult('success', 'สมัครสำเร็จ!', 'รอการอนุมัติจากผู้ดูแลระบบ เมื่ออนุมัติแล้วจะแจ้งเตือนทาง LINE');
        } else if (res.status === 409) {
          showResult('warning', 'คุณสมัครไว้แล้ว', 'กรุณารอการอนุมัติจากผู้ดูแลระบบ');
        } else {
          showResult('error', 'เกิดข้อผิดพลาด', data.error || 'กรุณาลองใหม่อีกครั้ง');
        }
      } catch (err) {
        console.error('Register error:', err);
        showResult('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้');
      }
    }

    function showResult(type, title, subtitle) {
      var icons = { success: '\u2714', error: '\u2716', warning: '\u26A0' };
      var content = document.getElementById('content');
      content.innerHTML =
        '<div class="card">' +
          '<div class="result">' +
            '<div class="result-icon ' + type + '">' + icons[type] + '</div>' +
            '<div class="result-msg">' + escHtml(title) + '</div>' +
            '<div class="result-sub">' + escHtml(subtitle) + '</div>' +
          '</div>' +
        '</div>';
    }

    function showError(msg) {
      showResult('error', 'ข้อผิดพลาด', msg);
    }

    function escHtml(str) {
      var div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    init();
  </script>
</body>
</html>
